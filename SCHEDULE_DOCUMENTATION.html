<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMC Analytics - Schedule System Documentation</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 8px;
            margin-bottom: 40px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .section {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .section h3 {
            color: #764ba2;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .diagram-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
            border: 1px solid #e0e0e0;
        }
        
        .mermaid {
            display: flex;
            justify-content: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #667eea;
            color: white;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #667eea;
            margin: 15px 0;
        }
        
        .note {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .download-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-top: 40px;
        }
        
        .download-btn {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 12px 24px;
            border-radius: 5px;
            text-decoration: none;
            margin: 10px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            font-size: 1em;
            transition: transform 0.2s;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .toc {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .toc h2 {
            color: #667eea;
            border: none;
            padding: 0;
            margin-bottom: 15px;
        }
        
        .toc ul {
            list-style: none;
            margin-left: 0;
        }
        
        .toc li {
            margin: 8px 0;
        }
        
        .toc a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #ddd;
            margin-top: 40px;
        }
        
        @media print {
            body {
                background: white;
            }
            .section {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
            .download-section {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä PMC Analytics Schedule System</h1>
            <p class="subtitle">Complete Documentation & Data Flow Guide</p>
        </header>
        
        <div class="toc">
            <h2>üìë Table of Contents</h2>
            <ul>
                <li><a href="#overview">System Overview</a></li>
                <li><a href="#collections">Firestore Collections</a></li>
                <li><a href="#views">Three Schedule Views</a></li>
                <li><a href="#flow">Data Loading Flow</a></li>
                <li><a href="#architecture">System Architecture</a></li>
                <li><a href="#priority">Priority & Deduplication</a></li>
                <li><a href="#case-study">Case Study: Canine Partners</a></li>
                <li><a href="#rules">Key Rules & Consistency</a></li>
            </ul>
        </div>
        
        <section id="overview" class="section">
            <h2>üéØ System Overview</h2>
            <p>The analytics platform uses a multi-level scheduling system with three main views (Long-term, Project Gantt, Short-term) that all pull from shared Firestore collections, with specific priority rules determining which data source takes precedence.</p>
            
            <div class="note">
                <strong>Key Concept:</strong> All three schedule pages use the same data sources in the same priority order, ensuring consistency across the platform.
            </div>
        </section>
        
        <section id="collections" class="section">
            <h2>üóÑÔ∏è Firestore Collections (Data Sources)</h2>
            
            <h3>1. schedules (Primary Source of Truth)</h3>
            <p><strong>Purpose:</strong> Centralized allocation storage with monthly percentages</p>
            <p><strong>Usage:</strong> NEW standard - set in Scheduling page, used by all three schedule views</p>
            <div class="success">
                <strong>‚úÖ Best Practice:</strong> This is the primary place to enter project allocations. Changes here automatically appear on all three schedule views.
            </div>
            
            <h3>2. projectScopes (Explicit Scope Definitions)</h3>
            <p><strong>Purpose:</strong> Define specific project scopes with exact start/end dates and work details</p>
            <p><strong>Usage:</strong> SHORT-TERM schedule processes these FIRST if dates overlap 5-week window</p>
            <p><strong>Priority:</strong> Highest - scopes override long-term & schedules collection data</p>
            
            <h3>3. long term schedual (Legacy Monthly Data)</h3>
            <p><strong>Purpose:</strong> Historical month-based schedule (older system)</p>
            <p><strong>Usage:</strong> Fallback source when scopes unavailable</p>
            <p><strong>Priority:</strong> Medium - used by all three views if no scopes</p>
            
            <h3>4. short term schedual (Daily Assignments)</h3>
            <p><strong>Purpose:</strong> Track which foreman assigned to which project on which day</p>
            <p><strong>Usage:</strong> SHORT-TERM schedule uses this to show foreman assignments</p>
            <p><strong>Priority:</strong> HIGHEST for foreman display (overlays on top of all other sources)</p>
        </section>
        
        <section id="views" class="section">
            <h2>üëÅÔ∏è The Three Schedule Views</h2>
            
            <h3>1. Long-Term Schedule (15-week view)</h3>
            <p><strong>File:</strong> src/app/long-term-schedule/page.tsx</p>
            <p><strong>Data Loading Priority:</strong></p>
            <ol>
                <li>Scopes from projectScopes (if startDate/endDate within 15-week window)</li>
                <li>Long-term schedual from "long term schedual" collection</li>
                <li>Monthly allocations from "schedules" collection</li>
            </ol>
            <p><strong>Output:</strong> Project cards grouped by week showing total hours</p>
            
            <h3>2. Project Schedule (Gantt Chart)</h3>
            <p><strong>File:</strong> src/app/project-schedule/hooks/useProjectSchedule.ts</p>
            <p><strong>Data Loading Priority:</strong></p>
            <ol>
                <li>Scopes from projectScopes</li>
                <li>Short-term schedual data</li>
                <li>Long-term schedual</li>
                <li>Monthly allocations from "schedules" collection</li>
            </ol>
            <p><strong>Output:</strong> Gantt-style timeline showing project duration and monthly breakdown</p>
            
            <h3>3. Short-Term Schedule (5-week daily view)</h3>
            <p><strong>File:</strong> src/app/short-term-schedule/page.tsx</p>
            <p><strong>Data Loading Priority:</strong></p>
            <ol>
                <li>Scopes from projectScopes (if dates in window)</li>
                <li>Long-term schedual (only if NOT in scopes)</li>
                <li>Monthly allocations from "schedules" collection (if NOT in 1 or 2)</li>
                <li>Foreman assignments from short term schedual (overlay on top)</li>
            </ol>
            <p><strong>Output:</strong> Daily grid showing projects, hours, and assigned foreman</p>
        </section>
        
        <section id="flow" class="section">
            <h2>üîÑ Data Loading Flow Diagram</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph TD
    A["üìñ Start: Load Project Data<br/>for 5-Week Window"] --> B{"Has scopes in<br/>projectScopes?"}
    
    B -->|Yes & dates overlap| C["‚úÖ Use Project Scopes<br/>- Extract start/end dates<br/>- Calculate: manpower√ó10 or hours√∑days<br/>Mark: In-Window Data Found"]
    B -->|No or outside window| D{"Has data in<br/>long term schedual?"}
    
    D -->|Yes & within window| E["‚úÖ Use Long-term Data<br/>- Extract weekly hours<br/>- Divide by 5 for daily<br/>Mark: In-Window Data Found"]
    D -->|No or outside window| F{"Has allocation in<br/>schedules collection?"}
    
    F -->|Yes & month overlaps| G["‚úÖ Use Schedules Allocation<br/>- Find Mondays in month<br/>- Calculate: totalHours √ó % √∑ Mondays √∑ 5<br/>Result: Hours per day"]
    F -->|No| H["‚ùå No data - Skip Project"]
    
    C --> I{"Already marked<br/>with data?"}
    E --> I
    G --> I
    
    I -->|Yes| J["üö´ Skip schedules collection<br/>Prevent duplication"]
    I -->|No| K["‚úÖ Add to display"]
    
    J --> L{"Short-term schedual<br/>has foreman?"}
    K --> L
    H --> M["Project not shown"]
    
    L -->|Yes| N["üë§ Add Foreman Overlay<br/>- Show foreman name<br/>- Allow X to remove<br/>Unassigned available"]
    L -->|No| O["Show with empty foreman<br/>Ready for assignment"]
    
    N --> P["üéØ Final Display<br/>Project + Hours + Foreman"]
    O --> P
    M --> Q["Hidden from view"]
                </div>
            </div>
        </section>
        
        <section id="architecture" class="section">
            <h2>üèóÔ∏è System Architecture</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph LR
    DB["üóÑÔ∏è FIRESTORE DATA"]
    
    DB -->|Explicit dates<br/>start/end| SCOPES["üìç projectScopes<br/>- Scope definitions<br/>- Manpower or hours<br/>- Date ranges"]
    
    DB -->|Legacy monthly| LONGTERM["üìÖ long term schedual<br/>- Month-based<br/>- Weekly totals<br/>- Historical data"]
    
    DB -->|Current allocations| SCHEDULES["üìä schedules<br/>- Monthly %<br/>- Total hours<br/>- Source of truth"]
    
    DB -->|Daily assignments| SHORTTERM["üë§ short term schedual<br/>- Foreman assignments<br/>- Daily hours detail<br/>- Override source"]
    
    SCOPES --> L1["üîµ LONG-TERM SCHEDULE<br/>15-week view"]
    LONGTERM --> L1
    SCHEDULES --> L1
    
    SCOPES --> L2["üü¢ PROJECT GANTT<br/>Monthly view"]
    LONGTERM --> L2
    SCHEDULES --> L2
    SHORTTERM --> L2
    
    SCOPES --> L3["üü° SHORT-TERM SCHEDULE<br/>5-week daily view"]
    LONGTERM --> L3
    SCHEDULES --> L3
    SHORTTERM --> L3
                </div>
            </div>
        </section>
        
        <section id="priority" class="section">
            <h2>‚ö° Priority & Deduplication</h2>
            <table>
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>Winners</th>
                        <th>Losers</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Project has scopes with dates in window</td>
                        <td>Scopes</td>
                        <td>Long-term, Schedules</td>
                    </tr>
                    <tr>
                        <td>Project scopes exist but dates outside window</td>
                        <td>Schedules OR Long-term</td>
                        <td>Scopes (irrelevant)</td>
                    </tr>
                    <tr>
                        <td>Project in schedules collection only</td>
                        <td>Schedules</td>
                        <td>Long-term</td>
                    </tr>
                    <tr>
                        <td>Project in long-term schedual collection</td>
                        <td>Long-term</td>
                        <td>‚Äî</td>
                    </tr>
                    <tr>
                        <td>Foreman assigned in short-term</td>
                        <td>Short-term foreman overlay</td>
                        <td>(adds on top)</td>
                    </tr>
                    <tr>
                        <td>Project with no data in 5-week window</td>
                        <td>Not displayed</td>
                        <td>‚Äî</td>
                    </tr>
                </tbody>
            </table>
        </section>
        
        <section id="case-study" class="section">
            <h2>üî¨ Case Study: Canine Partners</h2>
            
            <h3>Current Setup</h3>
            <ul>
                <li>schedules collection: 531 total hours, 50% for 2026-03</li>
                <li>No scopes defined</li>
                <li>No long-term schedual data for March</li>
                <li>Short-term schedual: empty initially, foreman added later</li>
            </ul>
            
            <h3>Short-Term Schedule Flow (Feb 24 - Mar 30)</h3>
            <div class="diagram-container">
                <div class="mermaid">
graph TD
    A["üìä USER ENTERS ALLOCATION<br/>Canine Partners<br/>Total Hours: 531<br/>March 2026: 50%"] --> B["üíæ SAVED TO: schedules collection"]
    B --> C["üìñ SHORT-TERM LOADS<br/>Window: Feb 23 - Mar 30"]
    C --> D["üîç Check for applicable month<br/>2026-03 overlaps window<br/>‚úÖ YES"]
    D --> E["üìÖ Calculate month hours<br/>531 √ó 50% = 265.5 hours"]
    E --> F["üóìÔ∏è Find Mondays in window<br/>Mar 02, 09, 16, 23<br/>(4 weeks)"]
    F --> G["‚è∞ Hours per week<br/>265.5 √∑ 4 = 66.375"]
    G --> H["üìÜ Hours per day<br/>66.375 √∑ 5 = 13.275"]
    H --> I["üéØ Display<br/>Mar 02-23: ~13 hrs/day"]
    I --> J["‚úÖ SUCCESS:<br/>Canine Partners appears<br/>in early March weeks"]
                </div>
            </div>
            
            <h3>Result</h3>
            <p>Canine Partners appears on Short-term Schedule in weeks of Mar 02-23 with approximately 13.3 hours per day, distributed evenly across the valid weeks within the 5-week window.</p>
            
            <div class="success">
                <strong>‚úÖ Data Consistency:</strong> The same project shows the same hours on long-term, project Gantt, and short-term schedules (when in overlapping date windows).
            </div>
        </section>
        
        <section id="rules" class="section">
            <h2>üìã Key Rules & Consistency</h2>
            
            <h3>Rule 1: Window-Based Filtering</h3>
            <ul>
                <li>Long-term: 15 weeks</li>
                <li>Short-term: 5 weeks</li>
                <li>Only projects with data in window are displayed</li>
            </ul>
            
            <h3>Rule 2: Deduplication Priority</h3>
            <ul>
                <li>Once a project gets data from scopes within the window, it's marked "done"</li>
                <li>Prevents loading same project multiple times</li>
                <li><strong>Exception:</strong> Projects are only marked "done" if they actually contribute data</li>
                <li>Empty scopes outside window don't mark it done</li>
                <li>This allows schedules collection to pick up data</li>
            </ul>
            
            <h3>Rule 3: Foreman Assignment Overlay</h3>
            <ul>
                <li>Foreman data from short-term schedual always takes display priority</li>
                <li>Shows on top of hours from any source</li>
                <li>Clicking X removes foreman assignment (clears document entry)</li>
                <li>Project stays visible with hours from original source</li>
            </ul>
            
            <h3>Rule 4: Monthly Percentage Distribution</h3>
            <ul>
                <li>Percentages only apply to schedules collection</li>
                <li>Spread evenly across valid Mondays in month</li>
                <li>Each day gets: <code>totalHours √ó percent / 100 / numMondays / 5</code></li>
            </ul>
            
            <h3>Data Consistency Guarantee</h3>
            <p>All three views use these sources (with same priority):</p>
            <pre>Scopes (if in window) 
  ‚Üì (if not scopes)
Long-term schedual  
  ‚Üì (if not scopes or long-term)
Schedules collection (monthly %)</pre>
            
            <div class="success">
                <strong>‚úÖ This ensures:</strong>
                <ul>
                    <li>Same project shows same hours on all three views (if in same date window)</li>
                    <li>New allocations to schedules collection immediately appear everywhere</li>
                    <li>Older long-term schedual data acts as fallback</li>
                    <li>Scopes provide explicit control when needed</li>
                </ul>
            </div>
        </section>
        
        <section id="updates" class="section">
            <h2>üîÑ Updates & Modifications</h2>
            
            <h3>When User Updates Scheduling Page</h3>
            <ol>
                <li>Saves to schedules collection</li>
                <li>Next page load automatically reads updated allocations</li>
                <li>All three schedule views display new data</li>
            </ol>
            
            <h3>When User Assigns Foreman (Short-term)</h3>
            <ol>
                <li>Saves to short term schedual collection</li>
                <li>Foreman name appears next to project</li>
                <li>Hours from underlying source unchanged</li>
            </ol>
            
            <h3>When User Clicks X (Remove Foreman)</h3>
            <ol>
                <li>Deletes entry from short term schedual collection</li>
                <li>Foreman assignment cleared</li>
                <li>Project stays visible with original hours</li>
            </ol>
        </section>
        
        <div class="download-section">
            <h2>üì• Download Documentation</h2>
            <p>Get these files for offline reference and team sharing:</p>
            <a href="#" class="download-btn" onclick="downloadMarkdown(); return false;">üìÑ Markdown (.md)</a>
            <a href="#" class="download-btn" onclick="downloadJSON(); return false;">üìã JSON Data</a>
            <a href="#" class="download-btn" onclick="window.print(); return false;">üñ®Ô∏è Print PDF</a>
            <a href="#" class="download-btn" onclick="downloadMermaid(); return false;">üîÑ Mermaid Diagrams</a>
        </div>
        
        <footer>
            <p>PMC Analytics Schedule System Documentation</p>
            <p>Generated: February 24, 2026</p>
            <p>For questions or updates, contact your development team</p>
        </footer>
    </div>
    
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
        mermaid.contentLoaded();
        
        function downloadMarkdown() {
            const content = `# Schedule System Logic & Data Flow

## Overview
The analytics platform uses a multi-level scheduling system with three main views (Long-term, Project Gantt, Short-term) that all pull from shared Firestore collections, with specific priority rules determining which data source takes precedence.

---

## Firestore Collections (Data Sources)

### 1. **schedules** (Primary Source of Truth)
- **Purpose:** Centralized allocation storage with monthly percentages
- **Structure:**
\`\`\`json
{
  jobKey: "Customer~ProjectNumber~ProjectName",
  projectName: "Project Name",
  projectNumber: "2508 - CP",
  customer: "Customer Name",
  totalHours: 531,
  status: "In Progress",
  allocations: {
    "2026-03": 50,      // 50% for March
    "2026-04": 75,      // 75% for April
    "2026-05": 0
  }
}
\`\`\`
- **Usage:** NEW standard - set in Scheduling page, used by all three schedule views
- **Data Flow:** User enters allocation % ‚Üí Saving to schedules collection ‚Üí All views read it

### 2. **projectScopes** (Explicit Scope Definitions)
- **Purpose:** Define specific project scopes with exact start/end dates and work details
- **Usage:** SHORT-TERM schedule processes these FIRST if dates overlap 5-week window
- **Priority:** Highest - scopes override long-term & schedules collection data

### 3. **long term schedual** (Legacy Monthly Data)
- **Purpose:** Historical month-based schedule (older system)
- **Usage:** Fallback source when scopes unavailable
- **Priority:** Medium - used by all three views if no scopes

### 4. **short term schedual** (Daily Assignments)
- **Purpose:** Track which foreman assigned to which project on which day
- **Usage:** SHORT-TERM schedule uses this to show foreman assignments
- **Priority:** HIGHEST for foreman display (overlays on top of all other sources)

---

## The Three Schedule Views

### 1. **Long-Term Schedule** (15-week view)
**File:** src/app/long-term-schedule/page.tsx

**Data Loading Priority:**
1. Scopes from projectScopes
2. Long-term schedual
3. Monthly allocations from schedules collection

**Output:** Project cards grouped by week

---

### 2. **Project Schedule (Gantt Chart)** (Monthly view)
**File:** src/app/project-schedule/hooks/useProjectSchedule.ts

**Data Loading Priority:**
1. Scopes from projectScopes
2. Short-term schedual
3. Long-term schedual
4. Monthly allocations from schedules collection

**Output:** Gantt-style timeline

---

### 3. **Short-Term Schedule** (5-week daily view)
**File:** src/app/short-term-schedule/page.tsx

**Data Loading Priority:**
1. Scopes from projectScopes (if in window)
2. Long-term schedual (if no scopes)
3. Monthly allocations from schedules collection
4. Foreman assignments from short term schedual (overlay)

**Output:** Daily grid with crew assignment

---

## Key Rules

### Rule 1: Window-Based Filtering
- Long-term: 15 weeks
- Short-term: 5 weeks
- Only projects with data in window displayed

### Rule 2: Deduplication Priority
- Once data from scopes = marked done
- Prevents duplicates
- Exception: Only mark done if data actually in window

### Rule 3: Foreman Assignment Overlay
- Takes display priority
- Click X removes foreman (not project)
- Project stays visible with original hours

### Rule 4: Monthly Percentage Distribution
- Spread evenly across Mondays
- Formula: totalHours √ó percent / 100 / numMondays / 5

---

## Data Consistency Guarantee

All three views use same priority order:
1. Scopes (if in window)
2. Long-term schedual
3. Schedules collection (monthly %)

Result: Same project = same hours across all views (same date window)

---

## Case Study: Canine Partners

**Setup:**
- schedules: 531 total hours, 50% for 2026-03
- No scopes
- No long-term data for March

**Calculation:**
- Month hours: 531 √ó 50% = 265.5
- Valid Mondays in 5-week window: 4 (Mar 02, 09, 16, 23)
- Hours per week: 265.5 √∑ 4 = 66.375
- Hours per day: 66.375 √∑ 5 = 13.275

**Result:** Appears Mar 02-23 with ~13.3 hours/day

---

Documentation Generated: February 24, 2026`;
            
            downloadFile(content, 'SCHEDULE_SYSTEM_LOGIC.md', 'text/markdown');
        }
        
        function downloadMermaid() {
            const content = `# Mermaid Diagrams - PMC Analytics Schedule System

## Diagram 1: Data Loading Priority Flow
\`\`\`mermaid
graph TD
    A["üìñ Start: Load Project Data<br/>for 5-Week Window"] --> B{"Has scopes in<br/>projectScopes?"}
    
    B -->|Yes & dates overlap| C["‚úÖ Use Project Scopes<br/>- Extract start/end dates<br/>- Calculate: manpower√ó10 or hours√∑days<br/>Mark: In-Window Data Found"]
    B -->|No or outside window| D{"Has data in<br/>long term schedual?"}
    
    D -->|Yes & within window| E["‚úÖ Use Long-term Data<br/>- Extract weekly hours<br/>- Divide by 5 for daily<br/>Mark: In-Window Data Found"]
    D -->|No or outside window| F{"Has allocation in<br/>schedules collection?"}
    
    F -->|Yes & month overlaps| G["‚úÖ Use Schedules Allocation<br/>- Find Mondays in month<br/>- Calculate: totalHours √ó % √∑ Mondays √∑ 5<br/>Result: Hours per day"]
    F -->|No| H["‚ùå No data - Skip Project"]
    
    C --> I{"Already marked<br/>with data?"}
    E --> I
    G --> I
    
    I -->|Yes| J["üö´ Skip schedules collection<br/>Prevent duplication"]
    I -->|No| K["‚úÖ Add to display"]
    
    J --> L{"Short-term schedual<br/>has foreman?"}
    K --> L
    H --> M["Project not shown"]
    
    L -->|Yes| N["üë§ Add Foreman Overlay<br/>- Show foreman name<br/>- Allow X to remove<br/>Unassigned available"]
    L -->|No| O["Show with empty foreman<br/>Ready for assignment"]
    
    N --> P["üéØ Final Display<br/>Project + Hours + Foreman"]
    O --> P
    M --> Q["Hidden from view"]
\`\`\`

## Diagram 2: System Architecture
\`\`\`mermaid
graph LR
    DB["üóÑÔ∏è FIRESTORE DATA"]
    
    DB -->|Explicit dates<br/>start/end| SCOPES["üìç projectScopes<br/>- Scope definitions<br/>- Manpower or hours<br/>- Date ranges"]
    
    DB -->|Legacy monthly| LONGTERM["üìÖ long term schedual<br/>- Month-based<br/>- Weekly totals<br/>- Historical data"]
    
    DB -->|Current allocations| SCHEDULES["üìä schedules<br/>- Monthly %<br/>- Total hours<br/>- Source of truth"]
    
    DB -->|Daily assignments| SHORTTERM["üë§ short term schedual<br/>- Foreman assignments<br/>- Daily hours detail<br/>- Override source"]
    
    SCOPES --> L1["üîµ LONG-TERM SCHEDULE<br/>15-week view"]
    LONGTERM --> L1
    SCHEDULES --> L1
    
    SCOPES --> L2["üü¢ PROJECT GANTT<br/>Monthly view"]
    LONGTERM --> L2
    SCHEDULES --> L2
    SHORTTERM --> L2
    
    SCOPES --> L3["üü° SHORT-TERM SCHEDULE<br/>5-week daily view"]
    LONGTERM --> L3
    SCHEDULES --> L3
    SHORTTERM --> L3
\`\`\`

## Diagram 3: Hour Distribution Calculation
\`\`\`mermaid
graph TD
    A["üìä USER ENTERS ALLOCATION<br/>Canine Partners<br/>Total Hours: 531<br/>March 2026: 50%"] --> B["üíæ SAVED TO:<br/>schedules collection"]
    B --> C["üìñ DISPLAY PAGE LOADS<br/>Window: Feb 23 - Mar 30"]
    C --> D["üîç FIND MONTH OVERLAP<br/>2026-03 overlaps window<br/>‚úÖ YES"]
    D --> E["üìÖ CALCULATE MONTH HOURS<br/>531 √ó 50% = 265.5 hours"]
    E --> F["üóìÔ∏è FIND MONDAYS IN WINDOW<br/>Mar 02, 09, 16, 23<br/>(4 weeks)"]
    F --> G["‚è∞ HOURS PER WEEK<br/>265.5 √∑ 4 = 66.375"]
    G --> H["üìÜ HOURS PER DAY<br/>66.375 √∑ 5 = 13.275"]
    H --> I["üéØ APPLY TO SCHEDULE<br/>Mar 02-23: ~13.3 hrs/day"]
    I --> K["‚úÖ COMPLETE"]
\`\`\`

## Usage
1. Copy the mermaid code above
2. Paste into https://mermaid.live for live editing
3. Export as PNG, SVG, or PDF as needed
4. Or use in documentation tools that support Mermaid syntax`;
            
            downloadFile(content, 'MERMAID_DIAGRAMS.md', 'text/markdown');
        }
        
        function downloadJSON() {
            const data = {
                "system": "PMC Analytics Schedule System",
                "version": "2.0",
                "collections": {
                    "schedules": {
                        "purpose": "Primary source of truth for allocations",
                        "structure": {
                            "jobKey": "string",
                            "projectName": "string",
                            "totalHours": "number",
                            "allocations": {
                                "YYYY-MM": "percentNumber"
                            }
                        }
                    },
                    "projectScopes": {
                        "purpose": "Explicit scope definitions with dates",
                        "structure": {
                            "jobKey": "string",
                            "startDate": "YYYY-MM-DD",
                            "endDate": "YYYY-MM-DD",
                            "manpower": "number",
                            "hours": "number"
                        }
                    },
                    "long_term_schedual": {
                        "purpose": "Legacy monthly schedule data",
                        "structure": {
                            "jobKey": "string",
                            "month": "YYYY-MM",
                            "weeks": [{"weekNumber": "number", "hours": "number"}]
                        }
                    },
                    "short_term_schedual": {
                        "purpose": "Daily foreman assignments",
                        "structure": {
                            "jobKey_month": "string",
                            "weeks": [{"weekNumber": "number", "days": [{"dayNumber": "number", "hours": "number", "foreman": "employeeId"}]}]
                        }
                    }
                },
                "views": {
                    "long_term_schedule": {
                        "file": "src/app/long-term-schedule/page.tsx",
                        "window": "15 weeks",
                        "priority": ["scopes", "long_term_schedual", "schedules"]
                    },
                    "project_gantt": {
                        "file": "src/app/project-schedule/hooks/useProjectSchedule.ts",
                        "window": "monthly",
                        "priority": ["scopes", "short_term_schedual", "long_term_schedual", "schedules"]
                    },
                    "short_term_schedule": {
                        "file": "src/app/short-term-schedule/page.tsx",
                        "window": "5 weeks",
                        "priority": ["scopes", "long_term_schedual", "schedules", "foreman_overlay"]
                    }
                },
                "rules": {
                    "window_filtering": "Only projects with data in current window displayed",
                    "deduplication": "Mark as done only if contributes data in window",
                    "foreman_overlay": "Takes highest display priority, click X to remove",
                    "allocation_distribution": "Spread monthly % evenly across valid Mondays"
                }
            };
            
            downloadFile(JSON.stringify(data, null, 2), 'SCHEDULE_CONFIG.json', 'application/json');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
